---
import BaseLayout from '@layouts/BaseLayout.astro';
import AddToCartButton from '@islands/AddToCartButton';
import type { Product } from '@/types';

const BACKEND_URL = import.meta.env.BACKEND_URL ?? 'http://localhost:4000';
const { id } = Astro.params;

let product: Product | null = null;

try {
  const res = await fetch(`${BACKEND_URL}/api/products/${id}`);
  if (res.ok) {
    const json = await res.json();
    product = json.data;
  }
} catch {
  // Backend unreachable
}

if (!product) {
  return Astro.redirect('/');
}

const price = parseFloat(product.price);
---

<BaseLayout title={`${product.name} - Davivienda Store`}>
  <div class="mb-6">
    <a href="/" class="text-sm text-default-500 hover:text-foreground transition-colors">
      &larr; Back to Products
    </a>
  </div>

  <div class="grid gap-8 lg:grid-cols-2">
    <div class="overflow-hidden rounded-xl border border-divider">
      <img
        src={product.imageUrl || 'https://via.placeholder.com/600x400'}
        alt={product.name}
        class="w-full h-auto object-cover"
      />
    </div>

    <div class="space-y-6">
      {product.category && (
        <span class="text-sm text-default-400 uppercase tracking-wide">
          {product.category.name}
        </span>
      )}

      <h1 class="text-3xl font-bold">{product.name}</h1>

      <p class="text-2xl font-bold text-primary">${price.toFixed(2)}</p>

      <div class="prose prose-sm text-default-600 max-w-none">
        <p>{product.description}</p>
      </div>

      <div class="flex items-center gap-4 text-sm text-default-500">
        {product.stock > 0 ? (
          <span class="flex items-center gap-1">
            <span class="h-2 w-2 rounded-full bg-success"></span>
            {product.stock} in stock
          </span>
        ) : (
          <span class="flex items-center gap-1">
            <span class="h-2 w-2 rounded-full bg-danger"></span>
            Out of stock
          </span>
        )}
      </div>

      <AddToCartButton
        client:load
        productId={product.id}
        stock={product.stock}
      />
    </div>
  </div>
</BaseLayout>
